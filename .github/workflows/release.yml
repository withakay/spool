name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Version tag (e.g., v0.20.8)"
        required: true

permissions:
  contents: write

jobs:
  meta:
    name: Resolve release tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Derive tag
        id: meta
        run: |
          set -eu
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  validate_version:
    name: Validate tag matches crate version
    needs: [meta]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.meta.outputs.tag }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Validate version
        env:
          TAG: ${{ needs.meta.outputs.tag }}
        run: |
          set -eu

          VERSION="${TAG#v}"

          CARGO_VERSION=$(python3 - <<'PY'
          import json
          import subprocess

          out = subprocess.check_output([
            'cargo','metadata',
            '--manifest-path','spool-rs/Cargo.toml',
            '--format-version','1',
            '--no-deps',
          ])
          meta = json.loads(out)

          for pkg in meta['packages']:
            if pkg.get('name') == 'spool-cli':
              print(pkg['version'])
              raise SystemExit(0)

          raise SystemExit('spool-cli package not found')
          PY
          )

          if [ "$CARGO_VERSION" != "$VERSION" ]; then
            echo "Tag version ($VERSION) does not match spool-cli crate version ($CARGO_VERSION)"
            exit 1
          fi

  build:
    name: Build (${{ matrix.target }})
    needs: [meta, validate_version]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel
            target: x86_64-apple-darwin
            archive: tar.gz
            bin: spool
          - os: macos-14
            target: aarch64-apple-darwin
            archive: tar.gz
            bin: spool
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
            bin: spool
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz
            bin: spool
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            bin: spool.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.meta.outputs.tag }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux aarch64)
        if: runner.os == 'Linux' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: cargo install cross --locked

      - name: Build (cargo)
        if: ${{ !(runner.os == 'Linux' && matrix.target == 'aarch64-unknown-linux-gnu') }}
        run: |
          set -eu
          cargo build --manifest-path spool-rs/Cargo.toml -p spool-cli --bin spool --release --target "${{ matrix.target }}"

      - name: Build (cross)
        if: runner.os == 'Linux' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          set -eu
          cross build --manifest-path spool-rs/Cargo.toml -p spool-cli --bin spool --release --target "${{ matrix.target }}"

      - name: Package (tar.gz)
        if: matrix.archive == 'tar.gz'
        env:
          TAG: ${{ needs.meta.outputs.tag }}
          TARGET: ${{ matrix.target }}
        run: |
          set -eu
          VERSION="$TAG"

          ARCHIVE="spool-${VERSION}-${TARGET}.tar.gz"
          CHECKSUM="spool-${VERSION}-${TARGET}.sha256"
          tar -C "spool-rs/target/${TARGET}/release" -czf "$ARCHIVE" "${{ matrix.bin }}"

          if command -v shasum >/dev/null 2>&1; then
            HASH=$(shasum -a 256 "$ARCHIVE" | awk '{print $1}')
          else
            HASH=$(sha256sum "$ARCHIVE" | awk '{print $1}')
          fi

          printf '%s  %s\n' "$HASH" "$ARCHIVE" > "$CHECKSUM"

      - name: Package (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        env:
          TAG: ${{ needs.meta.outputs.tag }}
          TARGET: ${{ matrix.target }}
        run: |
          $VERSION = $env:TAG
          $TARGET = $env:TARGET
          $ARCHIVE = "spool-$VERSION-$TARGET.zip"
          $CHECKSUM = "spool-$VERSION-$TARGET.sha256"

          # Ensure the zip contains the binary at the archive root (no nested directories).
          Push-Location "spool-rs/target/$TARGET/release"
          Compress-Archive -Path "${{ matrix.bin }}" -DestinationPath (Join-Path $PWD.Path "../../../.." | Join-Path -ChildPath $ARCHIVE)
          Pop-Location

          $HASH = (Get-FileHash $ARCHIVE -Algorithm SHA256).Hash.ToLower()
          "$HASH  $ARCHIVE" | Out-File -Encoding ascii -NoNewline -FilePath $CHECKSUM
          Add-Content -Encoding ascii -Path $CHECKSUM -Value ""

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spool-${{ needs.meta.outputs.tag }}-${{ matrix.target }}
          path: |
            spool-${{ needs.meta.outputs.tag }}-${{ matrix.target }}.${{ matrix.archive }}
            spool-${{ needs.meta.outputs.tag }}-${{ matrix.target }}.sha256

  upload_assets:
    name: Upload release assets
    needs: [meta, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          set -eu
          mkdir -p out
          find dist -maxdepth 2 -type f -print -exec cp {} out/ \;

      - name: Build aggregated checksums
        run: |
          set -eu
          cd out
          cat ./*.sha256 > sha256sums.txt

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.meta.outputs.tag }}
        run: |
          set -eu
          gh release upload "$TAG" out/* --clobber
