name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Version tag (e.g., v0.20.8)"
        required: true

permissions:
  contents: read

jobs:
  update-formula:
    runs-on: ubuntu-latest
    env:
      TAP_REPO: withakay/homebrew-spool
      FORMULA_PATH: Formula/spool.rb
      OWNER_REPO: withakay/spool

    concurrency:
      group: formula-update
      cancel-in-progress: false

    steps:
      - name: Derive version + tarball URL
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "version=${TAG}" >> "$GITHUB_OUTPUT"
          echo "tar_url=https://github.com/${OWNER_REPO}/archive/refs/tags/${TAG}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Compute sha256
        id: sha
        run: |
          set -euo pipefail
          SHA256="$(
            curl --fail --location --silent --show-error "${{ steps.meta.outputs.tar_url }}" \
            | sha256sum | cut -d' ' -f1
          )"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Checkout tap (write-enabled)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          ref: main
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          persist-credentials: false

      - name: Update formula url/sha256
        run: |
          set -euo pipefail
          TAR_URL="${{ steps.meta.outputs.tar_url }}"
          SHA256="${{ steps.sha.outputs.sha256 }}"
          : "${TAR_URL:?missing TAR_URL from meta}"
          : "${SHA256:?missing SHA256 from sha}"

          # Check if url line exists (not commented)
          if grep -qE '^\s*url\s*"' "${FORMULA_PATH}"; then
            # Update existing url and sha256
            sed -i.bak -E "s|^(\s*url\s*\").*(\")|\1${TAR_URL}\2|" "${FORMULA_PATH}"
            sed -i.bak -E "s|^(\s*sha256\s*\").*(\")|\1${SHA256}\2|" "${FORMULA_PATH}"
          else
            # Add url and sha256 after license line (first release)
            sed -i.bak -E "/^\s*license\s/a\\
          url \"${TAR_URL}\"\\
          sha256 \"${SHA256}\"" "${FORMULA_PATH}"
          fi
          rm -f "${FORMULA_PATH}.bak"
          grep -En '^\s*(url|sha256)\s*"' "${FORMULA_PATH}"

      - name: Commit & push to main
        env:
          GH_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GH_NAME: github-actions[bot]
        run: |
          set -euo pipefail
          git config user.email "$GH_EMAIL"
          git config user.name "$GH_NAME"
          if git diff --quiet -- "${FORMULA_PATH}"; then
            echo "No changes to commit; skipping push."
            exit 0
          fi
          git add "${FORMULA_PATH}"
          git commit -m "spool ${{ steps.meta.outputs.version }}: bump formula"
          git remote set-url origin "https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/${{ env.TAP_REPO }}.git"
          git pull --rebase origin main
          git push origin HEAD:main
