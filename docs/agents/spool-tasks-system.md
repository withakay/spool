# Spool Tasks System

Date: 2026-01-31

## What It Is

The Spool tasks system is a **file-based task tracker**.

- Source of truth: `.spool/changes/<change-id>/tasks.md`
- Operations: `spool tasks ...` reads/parses the file, computes progress/readiness, updates status fields, and writes the file back.

There is no persistent database for tasks.

## Where It Lives (Code)

- Parsing, validation, readiness computation, and file editing:
  - `spool-rs/crates/spool-workflow/src/tasks.rs`
- CLI error formatting / blocking behavior for invalid tasks files:
  - `spool-rs/crates/spool-cli/src/diagnostics.rs`
- CLI subcommands that call into the parser/updater:
  - `spool-rs/crates/spool-cli/src/main.rs` (`spool tasks ...`)

## Formats Supported

Spool supports two tracking formats:

1. Enhanced tasks.md (structured markdown blocks)
2. Checkbox tasks.md (minimal `- [ ]` / `- [x]` list)

The format is auto-detected by regex heuristics.

### 1) Checkbox Format

Minimal compatibility mode:

```md
- [ ] First task
- [x] Done task
```

Characteristics:

- Each line becomes a task.
- Task IDs are implicit: `1..N`.
- No dependencies, no waves, no checkpoints.
- `spool tasks start` and `spool tasks shelve` are not supported (only complete).
- Readiness: all pending tasks are “ready”.

### 2) Enhanced Format (Informal “Schema”)

There is no separate YAML/JSON schema file for tasks.
The “schema” is the markdown convention implemented in code.

The enhanced template is generated by `spool tasks init` and is the best reference.

#### Structure

- Wave sections:
  - `## Wave <n>`
  - A line `- **Depends On**: ...` immediately under the wave header
- Task blocks:
  - `### Task <id>: <name>`
  - Fields under each task:
    - `- **Files**: ...`
    - `- **Dependencies**: ...`
    - `- **Action**:` followed by freeform lines until the next `- **...` field or a new header
    - `- **Verify**: ...` (optional)
    - `- **Done When**: ...` (optional)
    - `- **Updated At**: YYYY-MM-DD` (warning if missing, error if malformed)
    - `- **Status**: [ ] pending|in-progress|complete|shelved`
- Checkpoints section:
  - `## Checkpoints`
  - Checkpoint tasks use headings like `### Checkpoint: ...` and typically carry a `- **Type**: checkpoint` field.

#### Status Encoding

Enhanced status lines look like:

```md
- **Status**: [ ] pending
- **Status**: [ ] in-progress
- **Status**: [x] complete
- **Status**: [-] shelved
```

Only these status labels are recognized. Anything else yields a validation error.

## Validation Model

Parsing produces a `TasksParseResult` with:

- detected format
- parsed tasks
- parsed waves
- progress summary
- `diagnostics` (errors and warnings)

### Errors vs Warnings

- **Errors** are treated as blocking by the CLI.
  - `spool tasks status/next/start/complete/...` will refuse to proceed if diagnostics include errors.
  - `spool-cli` renders errors via `blocking_task_error_message(...)`.
- **Warnings** are non-blocking.
  - They exist to highlight drift from the intended structure.

### Examples of Validations (Enhanced)

Waves:

- Missing `Depends On` line: warning; defaults to “all previous waves”.
- Empty `Depends On`: error.
- Invalid `Depends On` entry (non-integer): error.
- Depends on missing wave: error.
- Depends on itself: error.
- Duplicate `Depends On` lines: warning.
- Wave dependency cycles: error (see cycle detection below).

Tasks:

- Task appears outside any wave section: warning.
- Missing or invalid status: error.
- Missing updated-at: warning.
- Invalid updated-at date format: error.

Dependencies:

- Missing dependency task: error.
- Cross-wave dependency: error (explicitly disallowed).
- Dependency is shelved: error (a non-shelved task cannot depend on a shelved task).
- Task dependency cycles: error (see cycle detection below).

## Readiness and “Next Task”

The readiness algorithm depends on format.

### Checkbox Format

- Any `pending` task is considered ready.

### Enhanced Format

Readiness is computed from:

1. Wave gating
  - With explicit wave metadata: a wave is unlocked when all waves it depends on are fully done.
  - Without explicit wave metadata: back-compat gating picks the first incomplete wave and blocks later waves.

2. Task dependencies
  - A task is ready only if all its dependencies are complete.
  - Cross-wave dependencies are disallowed and should be fixed instead of worked around.

3. Checkpoints
  - Checkpoint tasks typically have `wave: None` and are blocked until all waves are complete.

The CLI uses this to implement:

- `spool tasks next <change-id>`: show the next ready task
- `spool tasks status <change-id>`: show progress + ready/blocked breakdown

## Editing / Mutations

Enhanced format supports these state transitions:

- `spool tasks start <change-id> <task-id>`: `pending -> in-progress`
- `spool tasks complete <change-id> <task-id>`: `pending|in-progress -> complete`
- `spool tasks shelve <change-id> <task-id>`: `pending|in-progress -> shelved`
- `spool tasks unshelve <change-id> <task-id>`: `shelved -> pending`

The implementation updates:

- the `- **Status**:` line
- the `- **Updated At**:` line (inserts if missing)

Checkbox format:

- Only “complete” is supported (no in-progress, no shelve).

## Cycle Detection (SQLite)

Spool uses SQLite only for cycle detection and only in-memory:

- It builds an in-memory `edge(src,dst)` table and runs a recursive CTE.
- If it finds a cycle, it returns a human-readable path like `a -> b -> c -> a`.

This is used for:

- wave dependency cycles
- task dependency cycles

No persistent DB is created.

## Relationship to `spool validate` and “Schemas”

- The tasks format itself is not described by a schema YAML; it is code-defined.
- `spool validate` validates change artifacts against the change schema (proposal/spec/design/tasks artifacts existing and well-formed per schema expectations).
- Tasks-specific structural correctness is validated by the tasks parser diagnostics and enforced by `spool tasks ...` commands.

## Troubleshooting

- If `spool tasks ...` refuses to run, it is usually because tasks.md has diagnostics at **Error** level.
  - Run `spool tasks status <change-id>` to see the rendered validation messages.
- If tasks are all “blocked”, check:
  - wave `Depends On` lines
  - cross-wave dependencies (not allowed)
  - missing dependencies
  - checkpoints (blocked until waves complete)
